## 6장 - 가상 네트워크 서비스 Amazon VPC

AWS에서는 가상 네트워크 서비스인 Amazon VPC를 제공하며, 기본 VPC도 제공하고 있어 네트워크를 손쉽게 설정할 수 있다.

### Amazon VPC란: AWS에 생성하는 가상 네트워크

**AWS 상에 네트워크를 구축하기 위해 사용되는 것**이 **Amazon VIrtual Private Cloud(Amazon VPC)**이다.

**EC2**나 **RDS**의 경우 VPC를 선택하지 않으면 서버를 생성할 수 없기 때문에 리소스를 사용하기 위해서는 반드시 필요한 서비스이다.

VPC는 네트워크와 서브넷 범위, 라우팅 테이블, 네트워크 게이트웨이 등과 같은 가상 네트워킹 환경을 설정할 수 있다.

**VPC의 주요 기능**
- CIDR 블록 : 서브넷을 말한다. 네트워크를 나눈 범위이다.
- 서브넷 마스크 : 네트워크 크기를 계산하는 값이다.
- 가용 영역 : 서브넷이 구축된 물리적 장소
- 인터넷 게이트웨이 : 인터넷에 접속하기 위한 출입구로 VPC를 인터넷에 연결하지 않는 경우에는 불필요하다.
- 라우팅 : 어떤 데이터를 어디에 보낼지 조정한다. 일반적으로 게이트웨이와 라우팅으로 송수신을 설정하거나 공유기로 역할을 수행하지만 **AWS는 소프트웨어가 이 기능을 담당한다.**
- 라우팅 테이블 : 라우팅에 대한 설정이 기록된 테이블이다.
- 보안 그룹 : AWS가 제공하는 가상 방화벽이다. 인스턴스 단위로 설정하고 '거부'가 기본값이다.
- 네트워크 ACL : AWS가 제공하는 가상 방화벽으로 서브넷 단위로 설정된다.

#### VPC 네트워크의 특징

- 물리적인 라우터가 아닌 소프트웨어가 라우팅한다. 라우터는 IP 주소를 갖지 않는다.
- 라우팅 테이블 한 개에 서브넷 여러 개를 설정할 수 있다.
- VPC 한 개에 인터넷 게이트웨이는 한 개만 설정할 수 있고, IP 주소를 갖지 않는다.
- 서브넷 사이의 통신은 라우터 없이 직접 통신할 수 없다.(일반적인 네트워크의 경우 라우터 필요)

### VPC의 사용 절차: 가상 네트워크를 사용하자

![aws24.png](image%2Faws24.png)

- 인터넷 연결 여부와 오토 스케일링이 설계의 중요 포인트이다.
- 인터넷에 연결해야 한다면 인터넷 게이트웨이를 설정해야 하고, 오토 스케일링을 설정해야 한다면 서버가 자동으로 늘어나기 때문에 IP 주소를 많이 확보해 두어야 한다.
- 어떻게 해야 할지 잘 모를 때는 기본 VPC를 사용하기를 권장한다.

### 기본 VPC: AWS가 제공하는 기본 VPC

- AWS는 네트워크 지식이 없어도 VPC를 사용할 수 있도록 리전별로 기본 VPC를 제공한다.
- 특별한 요건이 없는 이상, 기본 VPC를 사용하는 편이 좋다.
- 기본 VPC는 서브넷과 인터넷 게이트웨이가 기본적으로 구성되어 있다.
- 기본 서브넷은 가용 영역별로 한 개씩 생성되어 있다. 서울 리전의 경우 총 4군데가 있다. (2021년 3월 기준)
- 인터넷 게이트웨이도 구성되어 있으므로 인터넷에 접속할 수 있다.
- 인터넷에 접속하고 싶지 않다면 별도의 VPC를 생성해야 한다.

![aws25.png](image%2Faws25.png)

### 서브넷과 DHCP: 사용할 범위 선택

서브넷이란 커다란 네트워크를 작게 나눈 네트워크를 말한다. 네트워크를 분할해 직접 통신할 수 있는 범위를 좁히고, 방화벽을 설정해 보안을 강화하는 것이 목적이다.

#### 네트워크의 범위와 CIDR 표기

네트워크와 서브넷의 범위를 나누고 그 단위를 표기하기 위해 CIDR 표기를 사용한다.

![aws26.png](image%2Faws26.png)
- CIDR은 IP 주소의 수를 나타낸다.
- / 뒤에 네트워크 길이를 숫자로 적어서 표기한다.
- /24이면 256개, /20이면 4,056개를 나타낸다.

![aws27.png](image%2Faws27.png)

#### IP 주소 할당과 DHCP

- 네트워크 및 서브넷에 사용되는 IP 주소의 범위는 관리자가 설정할 수 있다.
- DHCP(Dynamic Host Configration Protocol)에서 각 인스턴스에 IP 주소를 자동으로 할당한다.
- VPC에는 DHCP 서버가 동작하고 있어 인스턴스가 추가되면 해당 서브넷 범위의 IP 주소 중에 하나가 할당된다.

### 보안 그룹과 네트워크 ACL: 보안 설정

VPC의 가상 방화벽으로 보안 그룹과 네트워크 ACL이 있다. 이는 인바운드 트래픽(데이터 유입)과 아웃바운드 트래픽(데이터 유출)을 제어한다.
- 반드시 양쪽 모두 설정해야 하며 명시적 설정이 없다면 기본 설정이 적용된다.

| **항목**    | **보안 그룹**                                   | **네트워크 ACL**                              |
| --------- | ------------------------------------------- | ----------------------------------------- |
| 설정 범위     | 인스턴스에 대해 설정한다(보안 그룹을 최대 5개 할당할 수 있다)        | 서브넷에 설정한다.                                |
| 규칙        | 규칙 허용만 가능하다.                                | 규칙 허용과 거부가 가능하다.                          |
| 설정        | stateful  <br>(규칙과 상관없이 반환된 트래픽을 자동으로 허용한다) | stateless<br>(반환된 트래픽을 규칙에 따라 명시적으로 허용한다) |
| 규칙의 적용 순서 | 모든 규칙을 확인하여 트래픽의 허가 여부를 정한다.                | 순서대로 규칙을 처리하면서 트래픽의 허가 여부를 결정한다.          |

###  VPC 엔드포인트: 다른 AWS 서비스 및 엔드포인트 서비스와 연결

**VPC 엔드포인트**란 VPC 내부에서 VPC 외부로 접속하기 위한 연결점을 제공하는 서비스이다.

S3와 DynamoDB의 경우 VPC를 사용하지 않는 서비스라 VPC를 직접 연결해야할 필요가 있는데 그 때 사용하는 것이 엔드포인트 서비스이다.

> **엔드포인트 서비스는 확장성과 고가용성을 지원하며 네트워크 트래픽에 대해 자동으로 스케일링되기 때문에 네트워크 트래픽에 대해 고민하지 않아도 된다.**


제공되는 엔드포인트 서비스에는 두 종류가 있다.
- 인터페이스 엔드포인트 : 네트워크 인터페이스(ENI)로 구축하는 유형
- 게이트웨이 엔드포인트 : 라우팅 테이블에 설정된 내용을 라우팅하는 유형

### VPC 연결: VPC와 VPC의 연결과 VPC와 VPN의 연결

VPC와 다른 네트워크를 연결하는 방법은 몇 가지가 있는데, 대표적으로 **VPC 피어링**이나 **전송 게이트웨이**를 사용하는 방법이다. 그 외에 **VPN 연결**이나 **AWS Direct Connect**를 사용한다.

- **VPC 피어링** 기능을 활성화하면 다른 VPC나 네트워크에 연결이 가능하다.
- **VPC는 물리적 네트워크 또는 클라우드에도 접속할 수 있다.** AWS를 회사 LAN이나 온프레미스 시스템과 연결해 물리적인 네트워크의 연장선으로 사용할 수 있다.
- 전용선이나 가상 사설망(VPN)을 이용하면 AWS와 사내 LAN이나 온프레미스를 안전하게 연결할 수 있어서 통신내용이 누설될 걱정이 필요없다.
- AWS는 전용선 서비스로 **AWS Direct Connect**를 제공하며 가상 사설망 서비스로 **AWS VPN**을 제공한다.